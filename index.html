<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corners Predictor - API-Football</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e);
            color: #fff;
            text-align: center;
            padding: 20px;
            min-height: 100vh;
        }
        h1 { color: #ff5722; font-size: 2em; margin-bottom: 10px; }
        .subtitle { color: #aaa; margin-bottom: 20px; }
        .buttons { margin: 20px 0; }
        button {
            background: #ff5722; color: white; border: none; padding: 14px 28px; margin: 8px;
            font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 12px;
            transition: all 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        button:hover { background: #e64a19; transform: translateY(-2px); }
        button:disabled { background: #666; cursor: not-allowed; }
        table {
            width: 100%; max-width: 1200px; margin: 25px auto; border-collapse: collapse;
            background: #1a1a2e; border-radius: 12px; overflow: hidden;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            display: block; max-height: 600px; overflow-y: auto;
        }
        table thead { position: sticky; top: 0; background: #16213e; z-index: 10; }
        table tbody { display: table; width: 100%; }
        th { background: #16213e; padding: 16px; font-weight: bold; text-transform: uppercase; font-size: 0.9em; }
        td { padding: 14px; border-bottom: 1px solid #333; }
        tr:hover { background: #222840; }
        .hit { background: #2e7d32 !important; color: #fff; }
        .miss { background: #c62828 !important; color: #fff; }
        .pending { background: #ff8f00; color: #000; font-weight: bold; }
        #info {
            font-size: 1.1em; margin: 20px 0; padding: 15px;
            background: rgba(255, 87, 34, 0.1); border-radius: 12px; display: inline-block;
        }
        .loader {
            display: inline-block; width: 20px; height: 20px;
            border: 3px solid #f3f3f3; border-top: 3px solid #ff5722;
            border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error { color: #f44336; background: rgba(244, 67, 54, 0.1); padding: 10px; border-radius: 8px; margin: 10px 0; }
        .limit-info { color: #ffa500; font-size: 0.9em; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Corners Predictor <span id="version">v1.00</span> <span id="loader" class="loader" style="display:none;"></span></h1>
        <p class="subtitle">‚úÖ API-Football Only - Over 9.5 Corners Predictor</p>

        <div class="buttons">
            <button id="btn-today">POBIERZ MECZE NA DZI≈ö</button>
        </div>

        <p id="info">Kliknij przycisk, by pobraƒá mecze na dzi≈õ...</p>
        <p id="limit-info" class="limit-info"></p>

        <table id="matches" style="display:none;">
            <thead>
            <tr>
                <th>Mecz</th>
                <th>Liga</th>
                <th>Godzina</th>
                <th>Status</th>
                <th>Historia (ostatnie 5)</th>
            </tr>
            </thead>
            <tbody id="matches-body">
            </tbody>
        </table>

        <footer style="margin-top: 50px; font-size: 0.9em; color: #888;">
            <p>Corners Predictor ¬© 2025 | API-Football Only</p>
        </footer>
    </div>

    <script>
        // === KONFIGURACJA API-FOOTBALL ===
        const API_FOOTBALL_KEY = 'fb9b429fc619754e0ce3ad2a9e5be39b';
        const API_FOOTBALL_BASE_URL = 'https://v3.football.api-sports.io';
        
        let matches = [];
        let requestsUsed = 0;
        let requestsLimit = 100;

        // Za≈Çaduj wersjƒô przy starcie
        async function loadVersion() {
            try {
                const response = await fetch('version.json?t=' + Date.now());
                const data = await response.json();
                document.getElementById('version').textContent = 'v' + data.version;
                console.log('üìå Wersja aplikacji:', data.version, '| Ostatnia aktualizacja:', data.updated);
            } catch (e) {
                console.warn('Nie mo≈ºna za≈Çadowaƒá wersji:', e);
            }
        }
        loadVersion();
        
        // Event listener dla przycisku
        document.getElementById('btn-today').addEventListener('click', loadMatchesForToday);

        // === ETAP 3: Pobieranie mecz√≥w na dzie≈Ñ ===
        async function loadMatchesForToday() {
            const loader = document.getElementById('loader');
            const info = document.getElementById('info');
            const limitInfo = document.getElementById('limit-info');
            const btn = document.getElementById('btn-today');
            
            loader.style.display = 'inline-block';
            info.textContent = 'üîç Pobieranie mecz√≥w z API-Football...';
            btn.disabled = true;
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const url = `${API_FOOTBALL_BASE_URL}/fixtures?date=${today}&timezone=Europe/Warsaw`;
                
                console.log('üì° Pobieranie mecz√≥w na:', today);
                console.log('üì° URL:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'x-apisports-key': API_FOOTBALL_KEY
                    }
                });
                
                // Sprawd≈∫ limit zapyta≈Ñ z headers
                const remaining = response.headers.get('x-ratelimit-requests-remaining');
                const limit = response.headers.get('x-ratelimit-requests-limit');
                if (remaining && limit) {
                    requestsUsed = parseInt(limit) - parseInt(remaining);
                    requestsLimit = parseInt(limit);
                    limitInfo.textContent = `üìä Limit zapyta≈Ñ: ${requestsUsed}/${requestsLimit} u≈ºytych dzisiaj`;
                }
                
                if (!response.ok) {
                    if (response.status === 429) {
                        throw new Error('‚ùå OsiƒÖgniƒôto limit zapyta≈Ñ (100/dzie≈Ñ). Limit odnowi siƒô jutro o p√≥≈Çnocy UTC.');
                    }
                    throw new Error(`B≈ÇƒÖd HTTP ${response.status}: ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Odpowied≈∫ nie jest JSON');
                }
                
                const data = await response.json();
                
                console.log('üì¶ Odpowied≈∫ API-Football:', data);
                
                if (!data.response || !Array.isArray(data.response)) {
                    throw new Error('Nieprawid≈Çowa struktura odpowiedzi');
                }
                
                matches = data.response;
                console.log(`‚úÖ Pobrano ${matches.length} mecz√≥w`);
                
                // DEBUG: Sprawd≈∫ strukturƒô pierwszego meczu
                if (matches.length > 0) {
                    console.log('üìä STRUKTURA PIERWSZEGO MECZU:', matches[0]);
                    console.log('üìä ID dru≈ºyn:', {
                        homeId: matches[0].teams?.home?.id,
                        homeName: matches[0].teams?.home?.name,
                        awayId: matches[0].teams?.away?.id,
                        awayName: matches[0].teams?.away?.name,
                        leagueName: matches[0].league?.name,
                        fixtureDate: matches[0].fixture?.date,
                        fixtureTimestamp: matches[0].fixture?.timestamp
                    });
                    
                    // Sprawd≈∫ czy sƒÖ mecze z wczoraj (filtrowanie daty)
                    const todayStart = new Date(today + 'T00:00:00Z').getTime();
                    const todayEnd = todayStart + 86400000; // +24h
                    const matchesFromToday = matches.filter(m => {
                        const matchDate = m.fixture?.timestamp ? new Date(m.fixture.timestamp * 1000) : null;
                        return matchDate && matchDate.getTime() >= todayStart && matchDate.getTime() < todayEnd;
                    });
                    console.log(`üìÖ Mecze z dzisiaj (${today}): ${matchesFromToday.length}/${matches.length}`);
                    if (matches.length !== matchesFromToday.length) {
                        console.warn(`‚ö†Ô∏è UWAGA: ${matches.length - matchesFromToday.length} mecz√≥w NIE jest z dzisiaj!`);
                    }
                }
                
                // Filtruj tylko mecze z dzisiaj
                const todayStart = new Date(today + 'T00:00:00Z').getTime();
                const todayEnd = todayStart + 86400000;
                const todayMatches = matches.filter(m => {
                    const matchDate = m.fixture?.timestamp ? new Date(m.fixture.timestamp * 1000) : null;
                    return matchDate && matchDate.getTime() >= todayStart && matchDate.getTime() < todayEnd;
                });
                
                console.log(`üìÖ Po filtrowaniu: ${todayMatches.length} mecz√≥w z dzisiaj (z ${matches.length} pobranych)`);
                
                // Pobierz historiƒô dla ka≈ºdego meczu
                info.innerHTML = `‚úÖ Pobrano <strong>${todayMatches.length} mecz√≥w z dzisiaj</strong>. Pobieranie historii dru≈ºyn...`;
                await analyzeAllMatches(todayMatches);
                
                displayMatches(todayMatches);
                
                info.innerHTML = `‚úÖ Pobrano <strong>${todayMatches.length} mecz√≥w z dzisiaj</strong> z historiƒÖ dru≈ºyn (${today})`;
                
            } catch (error) {
                console.error('‚ùå B≈ÇƒÖd:', error);
                info.innerHTML = `<span class="error">${error.message}</span>`;
                document.getElementById('matches').style.display = 'none';
            } finally {
                loader.style.display = 'none';
                btn.disabled = false;
            }
        }

        // === ETAP 4: Pobieranie historii dru≈ºyn ===
        
        // Pobierz ostatnie 5 mecz√≥w dru≈ºyny
        async function getTeamLastMatches(teamId, limit = 5) {
            try {
                const url = `${API_FOOTBALL_BASE_URL}/fixtures?team=${teamId}&last=${limit}`;
                
                console.log(`   üîç Pobieram historiƒô dla dru≈ºyny ID=${teamId}, URL: ${url}`);
                
                const response = await fetch(url, {
                    headers: {
                        'x-apisports-key': API_FOOTBALL_KEY
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 429) {
                        throw new Error('LIMIT_ZAPYTAN');
                    }
                    console.warn(`‚ö†Ô∏è B≈ÇƒÖd pobierania historii dru≈ºyny ${teamId}: HTTP ${response.status}`);
                    const errorText = await response.text();
                    console.warn(`   Odpowied≈∫ b≈Çƒôdu:`, errorText.substring(0, 200));
                    return [];
                }
                
                const data = await response.json();
                console.log(`   üì¶ Odpowied≈∫ historii dla dru≈ºyny ${teamId}:`, data);
                
                if (!data.response || !Array.isArray(data.response)) {
                    console.warn(`   ‚ö†Ô∏è Brak danych.response dla dru≈ºyny ${teamId}`);
                    return [];
                }
                
                console.log(`   ‚úÖ Pobrano ${data.response.length} mecz√≥w z historii dla dru≈ºyny ${teamId}`);
                return data.response;
            } catch (error) {
                if (error.message === 'LIMIT_ZAPYTAN') {
                    throw error;
                }
                console.error(`‚ùå B≈ÇƒÖd pobierania historii dru≈ºyny ${teamId}:`, error);
                return [];
            }
        }
        
        // Pobierz statystyki meczu (ro≈ºne)
        async function getMatchStatistics(fixtureId) {
            try {
                const url = `${API_FOOTBALL_BASE_URL}/fixtures/statistics?fixture=${fixtureId}`;
                
                const response = await fetch(url, {
                    headers: {
                        'x-apisports-key': API_FOOTBALL_KEY
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 429) {
                        throw new Error('LIMIT_ZAPYTAN');
                    }
                    console.warn(`‚ö†Ô∏è B≈ÇƒÖd pobierania statystyk meczu ${fixtureId}: HTTP ${response.status}`);
                    return null;
                }
                
                const data = await response.json();
                if (!data.response || !Array.isArray(data.response) || data.response.length < 2) {
                    return null;
                }
                
                // response[0] = dru≈ºyna domowa, response[1] = dru≈ºyna wyjazdowa
                const homeStats = data.response[0].statistics || [];
                const awayStats = data.response[1].statistics || [];
                
                // Znajd≈∫ ro≈ºne
                const getStatValue = (stats, statType) => {
                    const stat = stats.find(s => s.type === statType);
                    return stat ? parseInt(stat.value || 0) : 0;
                };
                
                const homeCorners = getStatValue(homeStats, 'Corner Kicks');
                const awayCorners = getStatValue(awayStats, 'Corner Kicks');
                const totalCorners = homeCorners + awayCorners;
                    
                    return {
                    homeCorners,
                    awayCorners,
                    totalCorners
                };
            } catch (error) {
                if (error.message === 'LIMIT_ZAPYTAN') {
                    throw error;
                }
                console.error(`‚ùå B≈ÇƒÖd pobierania statystyk meczu ${fixtureId}:`, error);
                return null;
            }
        }
        
        // Pobierz historiƒô dla dru≈ºyny (ostatnie 5 mecz√≥w z ro≈ºnymi)
        async function getTeamHistory(teamId, teamName, isHome) {
            try {
                const lastMatches = await getTeamLastMatches(teamId, 5);
                
                if (lastMatches.length === 0) {
                    return {
                        matches: [],
                        cornersOwn: [],
                        cornersTotal: [],
                        avgCornersOwn: '-',
                        avgCornersTotal: '-'
                    };
                }
                
                // Pobierz statystyki dla ka≈ºdego meczu
                const history = [];
                const cornersOwn = [];
                const cornersTotal = [];
                
                for (const match of lastMatches) {
                    const fixtureId = match.fixture?.id;
                    if (!fixtureId) {
                        console.warn(`   ‚ö†Ô∏è Mecz bez ID:`, match);
                        continue;
                    }
                    
                    // Sprawd≈∫ czy mecz siƒô zako≈Ñczy≈Ç
                    const status = match.fixture?.status?.short;
                    console.log(`   üìÖ Mecz ${fixtureId}: status=${status}`);
                    
                    if (status !== 'FT') {
                        console.log(`   ‚è≠Ô∏è Pomijam mecz ${fixtureId} - status ${status} (nie FT)`);
                        continue; // Tylko zako≈Ñczone mecze
                    }
                    
                    // Sprawd≈∫ czy nasza dru≈ºyna gra≈Ça jako home czy away w tym meczu
                    const matchHomeId = match.teams?.home?.id;
                    const matchAwayId = match.teams?.away?.id;
                    const playedAsHome = matchHomeId === teamId;
                    
                    console.log(`   üè† Mecz ${fixtureId}: homeId=${matchHomeId}, awayId=${matchAwayId}, nasza dru≈ºyna=${teamId}, gra≈Ça jako home=${playedAsHome}`);
                    
                    if (!playedAsHome && matchAwayId !== teamId) {
                        console.warn(`   ‚ö†Ô∏è Nasza dru≈ºyna ${teamId} nie gra≈Ça w meczu ${fixtureId}`);
                        continue; // Nasza dru≈ºyna nie gra≈Ça w tym meczu
                    }
                    
                    const stats = await getMatchStatistics(fixtureId);
                    if (!stats) {
                        console.warn(`   ‚ö†Ô∏è Brak statystyk dla meczu ${fixtureId}`);
                        continue;
                    }
                    
                    console.log(`   ‚úÖ Statystyki dla meczu ${fixtureId}: homeCorners=${stats.homeCorners}, awayCorners=${stats.awayCorners}, total=${stats.totalCorners}`);
                    
                    // Zapisz ro≈ºne dla naszej dru≈ºyny i ≈ÇƒÖcznie
                    const ownCorners = playedAsHome ? stats.homeCorners : stats.awayCorners;
                    cornersOwn.push(ownCorners);
                    cornersTotal.push(stats.totalCorners);
                    
                    history.push({
                        opponent: playedAsHome ? match.teams?.away?.name : match.teams?.home?.name,
                        ownCorners,
                        totalCorners: stats.totalCorners
                    });
                    
                    // Op√≥≈∫nienie miƒôdzy zapytaniami (≈ºeby nie przekroczyƒá limitu)
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Oblicz ≈õrednie
                const avgCornersOwn = cornersOwn.length > 0 
                    ? (cornersOwn.reduce((a, b) => a + b, 0) / cornersOwn.length).toFixed(1)
                    : '-';
                const avgCornersTotal = cornersTotal.length > 0
                    ? (cornersTotal.reduce((a, b) => a + b, 0) / cornersTotal.length).toFixed(1)
                    : '-';
                
                return {
                    matches: history,
                    cornersOwn,
                    cornersTotal,
                    avgCornersOwn,
                    avgCornersTotal
                };
            } catch (error) {
                if (error.message === 'LIMIT_ZAPYTAN') {
                    throw error;
                }
                console.error(`‚ùå B≈ÇƒÖd pobierania historii dru≈ºyny ${teamId}:`, error);
                return {
                    matches: [],
                    cornersOwn: [],
                    cornersTotal: [],
                    avgCornersOwn: '-',
                    avgCornersTotal: '-'
                };
            }
        }
        
        // Analizuj wszystkie mecze
        async function analyzeAllMatches(matchesList) {
            const maxMatches = Math.min(10, matchesList.length); // Limit do 10 mecz√≥w ≈ºeby nie przekroczyƒá limitu zapyta≈Ñ
            
            // DEBUG: Szukaj konkretnego meczu "Grasshoppers vs BSC Young Boys"
            const testMatch = matchesList.find(m => {
                const home = m.teams?.home?.name || '';
                const away = m.teams?.away?.name || '';
                return (home.includes('Grasshoppers') && away.includes('Young Boys')) ||
                       (home.includes('Young Boys') && away.includes('Grasshoppers'));
            });
            
            if (testMatch) {
                console.log('üîç ZNALEZIONO MECZ TESTOWY:', testMatch);
                console.log('   Home ID:', testMatch.teams?.home?.id);
                console.log('   Away ID:', testMatch.teams?.away?.id);
                console.log('   Liga:', testMatch.league?.name);
                console.log('   Data:', testMatch.fixture?.date);
            }
            
            for (let i = 0; i < maxMatches; i++) {
                const match = matchesList[i];
                const homeTeamId = match.teams?.home?.id;
                const awayTeamId = match.teams?.away?.id;
                const homeTeamName = match.teams?.home?.name || 'Unknown';
                const awayTeamName = match.teams?.away?.name || 'Unknown';
                
                if (!homeTeamId || !awayTeamId) {
                    console.warn(`‚ö†Ô∏è Brak ID dru≈ºyn w meczu ${i + 1}: ${homeTeamName} vs ${awayTeamName}`);
                    continue;
                }
                
                console.log(`üìä Analizujƒô mecz ${i + 1}/${maxMatches}: ${homeTeamName} vs ${awayTeamName}`);
                console.log(`   Home ID: ${homeTeamId}, Away ID: ${awayTeamId}`);
                
                try {
                    // Pobierz historiƒô dla obu dru≈ºyn r√≥wnolegle
                    const [homeHistory, awayHistory] = await Promise.all([
                        getTeamHistory(homeTeamId, homeTeamName, true),
                        getTeamHistory(awayTeamId, awayTeamName, false)
                    ]);
                    
                    // Zapisz historiƒô w obiekcie meczu
                    match.homeHistory = homeHistory;
                    match.awayHistory = awayHistory;
                    
                    console.log(`   ‚úÖ Home: ${homeHistory.cornersOwn.length} mecz√≥w, ≈õrednia ro≈ºnych: ${homeHistory.avgCornersOwn}, ≈õrednia ≈ÇƒÖcznie: ${homeHistory.avgCornersTotal}`);
                    console.log(`   ‚úÖ Away: ${awayHistory.cornersOwn.length} mecz√≥w, ≈õrednia ro≈ºnych: ${awayHistory.avgCornersOwn}, ≈õrednia ≈ÇƒÖcznie: ${awayHistory.avgCornersTotal}`);
                    
                } catch (error) {
                    if (error.message === 'LIMIT_ZAPYTAN') {
                        throw new Error('‚ùå OsiƒÖgniƒôto limit zapyta≈Ñ podczas pobierania historii. Przerwano analizƒô.');
                    }
                    console.error(`‚ùå B≈ÇƒÖd analizy meczu ${i + 1}:`, error);
                }
            }
        }

        // === Wy≈õwietlanie mecz√≥w w tabeli ===
        function displayMatches(matchesList) {
            const table = document.getElementById('matches');
            const tbody = document.getElementById('matches-body');
            
            table.style.display = 'block';
            tbody.innerHTML = '';
            
            if (matchesList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">Brak mecz√≥w na dzi≈õ</td></tr>';
                    return;
                }
                    // Sortuj po lidze, potem po godzinie
            const sortedMatches = [...matchesList].sort((a, b) => {
                        const leagueA = a.league?.name || 'ZZZ';
                        const leagueB = b.league?.name || 'ZZZ';
                        if (leagueA !== leagueB) return leagueA.localeCompare(leagueB);
                        return (a.fixture?.timestamp || 0) - (b.fixture?.timestamp || 0);
                    });
                    
                    sortedMatches.forEach(match => {
                const homeTeam = match.teams?.home?.name || 'Unknown';
                const awayTeam = match.teams?.away?.name || 'Unknown';
                const leagueName = match.league?.name || 'Unknown League';
                const status = match.fixture?.status?.short || 'NS';
                const timestamp = match.fixture?.timestamp;
                
                let time = 'N/A';
                if (timestamp) {
                    const date = new Date(timestamp * 1000);
                                time = date.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
                }
                
                // Pobierz historiƒô je≈õli jest dostƒôpna
                let historyHtml = '<span style="color:#888;">Brak danych</span>';
                
                if (match.homeHistory && match.awayHistory) {
                    const home = match.homeHistory;
                    const away = match.awayHistory;
                    
                    historyHtml = `
                        <div style="text-align: left; font-size: 11px; line-height: 1.6;">
                            <strong style="color:#4a9eff;">üè† ${homeTeam}:</strong><br>
                            üìä Ostatnie 5: ${home.cornersOwn.length > 0 ? home.cornersOwn.join(', ') : 'brak'}<br>
                            üìà ≈ör. ro≈ºnych: ${home.avgCornersOwn}<br>
                            ‚öΩ ≈ör. ≈ÇƒÖcznie: ${home.avgCornersTotal}<br>
                            <br>
                            <strong style="color:#ff6b6b;">‚úàÔ∏è ${awayTeam}:</strong><br>
                            üìä Ostatnie 5: ${away.cornersOwn.length > 0 ? away.cornersOwn.join(', ') : 'brak'}<br>
                            üìà ≈ör. ro≈ºnych: ${away.avgCornersOwn}<br>
                            ‚öΩ ≈ör. ≈ÇƒÖcznie: ${away.avgCornersTotal}
                        </div>
                    `;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${homeTeam} vs ${awayTeam}</strong></td>
                    <td>${leagueName}</td>
                    <td>${time}</td>
                    <td class="pending">${status}</td>
                    <td style="text-align: left;">${historyHtml}</td>
                `;
                tbody.appendChild(row);
            });
        }
    </script>
</body>
</html>
