<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corners Predictor v12 ‚Äì 6 ≈πR√ìDE≈Å | 60%+</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e);
            color: #fff;
            text-align: center;
            padding: 20px;
            min-height: 100vh;
        }
        h1 { color: #ff5722; font-size: 2em; margin-bottom: 10px; }
        .subtitle { color: #aaa; margin-bottom: 20px; }
        .buttons { margin: 20px 0; }
        button {
            background: #ff5722; color: white; border: none; padding: 14px 28px; margin: 8px;
            font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 12px;
            transition: all 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        button:hover { background: #e64a19; transform: translateY(-2px); }
        table {
            width: 100%; max-width: 1200px; margin: 25px auto; border-collapse: collapse;
            background: #1a1a2e; border-radius: 12px; overflow: hidden;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            display: block; max-height: 600px; overflow-y: auto;
        }
        table thead { position: sticky; top: 0; background: #16213e; z-index: 10; }
        table tbody { display: table; width: 100%; }
        th { background: #16213e; padding: 16px; font-weight: bold; text-transform: uppercase; font-size: 0.9em; }
        td { padding: 14px; border-bottom: 1px solid #333; }
        tr:hover { background: #222840; }
        .hit { background: #2e7d32 !important; animation: pulse 1s; color: #fff; }
        .miss { background: #c62828 !important; color: #fff; }
        .pending { background: #ff8f00; color: #000; font-weight: bold; }
        .medium { color: #ffd700; font-weight: bold; }
        .high { color: #00ff00; font-weight: bold; }
        .link { color: #4fc3f7; text-decoration: underline; cursor: pointer; }
        .details-row { background: #0f0f23 !important; }
        .details-content { padding: 20px; color: #ccc; line-height: 1.8; }
        .team-stats { display: inline-block; margin: 10px 20px; padding: 10px; background: #1a1a2e; border-radius: 8px; }
        .expand-btn { cursor: pointer; color: #4fc3f7; font-size: 0.9em; user-select: none; }
        #stats {
            font-size: 1.3em; margin: 25px 0; padding: 15px;
            background: rgba(255, 87, 34, 0.1); border-radius: 12px; display: inline-block;
        }
        canvas { margin: 30px auto; max-width: 400px; }
        .loader {
            display: inline-block; width: 20px; height: 20px;
            border: 3px solid #f3f3f3; border-top: 3px solid #ff5722;
            border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        footer { margin-top: 50px; font-size: 0.9em; color: #888; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Corners Predictor <span id="version">v1.01</span> <span id="loader" class="loader" style="display:none;"></span></h1>
        <p class="subtitle">üîß DEBUG MODE - TYLKO SPORTMONKS - wszystkie inne API wy≈ÇƒÖczone</p>

        <div class="buttons">
            <button onclick="loadTodayMatches()">SZUKAJ MECZ√ìW NA DZI≈ö</button>
            <button onclick="loadMatchesForDate(1)">JUTRO</button>
            <button onclick="loadMatchesForDate(-1)">WCZORAJ</button>
            <button onclick="checkAvailableLeagues()">SPRAWD≈π DOSTƒòPNE LIGI</button>
            <button onclick="verifyAll()">SPRAWD≈π WYNIKI</button>
        </div>

        <p id="info">Kliknij przycisk, by pobraƒá mecze na dzi≈õ...</p>
        <p id="api-status" style="font-size: 0.9em; color: #ffa500; margin-top: 10px;"></p>

        <table id="predictions" style="display:none;">
            <tr>
                <th>Mecz</th>
                <th>Liga</th>
                <th>≈örednia %</th>
                <th>ZGODNO≈öƒÜ</th>
                <th>Link</th>
                <th>Status</th>
            </tr>
        </table>

        <div id="stats">Hit Rate: ‚Äî | ROI: ‚Äî</div>
        <canvas id="chart"></canvas>

        <footer>
            <p>CornersBot v12 ¬© 2025 | 6 ≈∫r√≥de≈Ç | corsproxy.io</p>
        </footer>
    </div>

    <script>
        // === KLUCZE (UKRYTE) ===
        const SPORTMONKS_KEY = 'zWSF4VIJJHhBOw4xizgqFPS795qiOdxes0y9B1AhqeBeAKBLrKx8283Ivsks';
        const FOOTYSTATS_KEY = '8cdad7757b702fae3b792c0b3328017ee33cc17594b18ea8a2717cdc53162325';
        
        // Mo≈ºesz dodaƒá wiƒôcej kluczy API-Football (je≈õli masz)
        const API_FOOTBALL_KEYS = [
            'fb9b429fc619754e0ce3ad2a9e5be39b',
            // 'DODAJ_TUTAJ_KOLEJNY_KLUCZ_JE≈öLI_MASZ',
            // 'I_KOLEJNY',
        ];
        let currentKeyIndex = 0;

        // === PROXY (DZIA≈ÅA Z HEADERAMI!) ===
        const PROXY = 'https://corsproxy.io/?';

        let predictions = [];
        let hits = 0, total = 0;
        let chartInstance = null;
        let apiFootballLimitReached = false;

        // Za≈Çaduj wersjƒô przy starcie
        async function loadVersion() {
            try {
                const response = await fetch('version.json?t=' + Date.now());
                const data = await response.json();
                document.getElementById('version').textContent = 'v' + data.version;
                console.log('üìå Wersja aplikacji:', data.version, '| Ostatnia aktualizacja:', data.updated);
            } catch (e) {
                console.warn('Nie mo≈ºna za≈Çadowaƒá wersji:', e);
            }
        }
        
        // Uruchom przy ≈Çadowaniu strony
        loadVersion();

        // Funkcja pomocnicza do przetwarzania mecz√≥w
        async function processFixtures(fixtures) {
                for (let fix of fixtures) {
                    const home = fix.teams.home.name;
                    const away = fix.teams.away.name;
                    const league = fix.league.name;
                    const id = fix.fixture.id;
                    const flashscore = `https://www.flashscore.pl/mecz/${home.toLowerCase().replace(/ /g,'-')}-${away.toLowerCase().replace(/ /g,'-')}/${id}/`;

                console.log(`\nüéØ Analizujƒô: ${home} vs ${away}`);

                    const probs = await getAllProbabilities(home, away, id, league);
                if (!probs) {
                    console.log('‚ùå B≈ÇƒÖd pobierania prawdopodobie≈Ñstw');
                    continue;
                }

                console.log('üìä Prawdopodobie≈Ñstwa:', probs);

                    // Filtrujemy tylko aktywne ≈∫r√≥d≈Ça (nie null, nie 0)
                    const activeProbs = probs.filter(p => p && p > 0);
                    const avgProb = activeProbs.length > 0 
                        ? Math.round(activeProbs.reduce((a, b) => a + b, 0) / activeProbs.length)
                        : 0;
                    const agree = activeProbs.length > 0
                        ? Math.round(activeProbs.filter(p => p >= 60).length / activeProbs.length * 100)
                        : 0;

                console.log(`üìà ≈örednia: ${avgProb}% | Zgodno≈õƒá: ${agree}% (z ${activeProbs.length} ≈∫r√≥de≈Ç)`);

                    // ‚ö†Ô∏è ZMIENIONE: Pr√≥g obni≈ºony do 30% bo wiƒôkszo≈õƒá API wy≈ÇƒÖczona
                    if (agree >= 30 && avgProb >= 55) {
                    console.log('‚úÖ Mecz spe≈Çnia kryteria (zgdn.‚â•30%, ≈õr.‚â•55%)!');
                        predictions.push({
                            match: `${home} vs ${away}`,
                            league,
                            avgProb,
                            agree,
                            flashscore,
                            id,
                        status: 'Oczekuje',
                        homeTeam: home,
                        awayTeam: away
                    });
                } else {
                    console.log(`‚ùå Mecz NIE spe≈Çnia kryteri√≥w (zgdn:${agree}%<30% LUB ≈õr:${avgProb}%<55%)`);
                }
            }
        }

        async function loadMatchesForDate(daysOffset = 0) {
            document.getElementById('loader').style.display = 'inline-block';
            document.getElementById('info').textContent = 'üîß DEBUG: Testujƒô tylko Sportmonks API...';
            document.getElementById('predictions').style.display = 'none';
            predictions = [];

            try {
                const date = new Date();
                date.setDate(date.getDate() + daysOffset);
                const dateStr = date.toISOString().split('T')[0];
                
                console.log('üîç Pobieranie mecz√≥w na:', dateStr);
                console.log('‚ö†Ô∏è API-FOOTBALL TYMCZASOWO WY≈ÅƒÑCZONE - u≈ºywam Sportmonks');
                document.getElementById('api-status').innerHTML = '‚ö†Ô∏è <strong>API-Football wy≈ÇƒÖczone (test)</strong> - u≈ºywam Sportmonks';
                
                // TYMCZASOWO: Od razu u≈ºywaj Sportmonks zamiast API-Football
                let fixtures = null;
                
                // Pr√≥buj Sportmonks jako g≈Ç√≥wne ≈∫r√≥d≈Ço
                console.log('üîÑ U≈ºywam Sportmonks jako g≈Ç√≥wnego ≈∫r√≥d≈Ça...');
                
                // U≈ªYWAMY PROXY (bezpo≈õrednie po≈ÇƒÖczenie blokuje CORS)
                // DODANO: include=league ≈ºeby pobraƒá nazwƒô ligi
                const sportmonksUrl = `${PROXY}https://api.sportmonks.com/v3/football/fixtures/date/${dateStr}?api_token=${SPORTMONKS_KEY}&include=league`;
                console.log('üì° Sportmonks URL (przez PROXY, z league):', sportmonksUrl);
                console.log('üìÖ Data szukania:', dateStr);
                
                let smRes;
                try {
                    smRes = await fetch(sportmonksUrl);
                    console.log('üìù Sportmonks Status:', smRes.status);
                } catch (fetchError) {
                    console.error('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia:', fetchError);
                    throw new Error('Nie mo≈ºna po≈ÇƒÖczyƒá siƒô z API: ' + fetchError.message);
                }
                
                console.log('üìù Sportmonks Status Text:', smRes.statusText);
                console.log('üìù Sportmonks Headers:', Array.from(smRes.headers.entries()));
                
                // Sprawd≈∫ content-type przed parsowaniem
                const contentType = smRes.headers.get('content-type');
                console.log('üìù Content-Type:', contentType);
                
                let smData;
                if (contentType && contentType.includes('application/json')) {
                    smData = await smRes.json();
                } else {
                    // Odpowied≈∫ nie jest JSON (prawdopodobnie HTML z b≈Çƒôdem)
                    const textResponse = await smRes.text();
                    console.error('‚ùå Odpowied≈∫ NIE JEST JSON:', textResponse.substring(0, 200));
                    
                    if (smRes.status === 403) {
                        throw new Error('‚õî CORS Proxy (corsproxy.io) zablokowany przez Cloudflare! Spr√≥buj za 5-10 minut lub u≈ºyj VPN.');
                    }
                    
                    throw new Error(`Sportmonks zwr√≥ci≈Ço ${smRes.status}: ${textResponse.substring(0, 100)}`);
                }
                console.log('üì¶ Sportmonks PE≈ÅNA ODPOWIED≈π:', JSON.stringify(smData, null, 2));
                
                // Sprawd≈∫ pagination
                if (smData.pagination) {
                    console.log('üìÑ PAGINATION:', smData.pagination);
                    console.log(`   Strona: ${smData.pagination.current_page}/${smData.pagination.last_page}`);
                    console.log(`   Razem: ${smData.pagination.total} mecz√≥w`);
                }
                
                if (smRes.ok) {
                    console.log('‚úÖ Sportmonks odpowied≈∫ OK');
                    console.log('üìä Struktura odpowiedzi:', Object.keys(smData));
                    
                    if (smData.data && smData.data.length > 0) {
                        console.log(`‚úÖ [Sportmonks] Znaleziono ${smData.data.length} mecz√≥w na tej stronie`);
                        
                        // Sprawd≈∫ czy sƒÖ kolejne strony
                        let allFixtures = [...smData.data];
                        const totalPages = smData.pagination?.last_page || 1;
                        const currentPage = smData.pagination?.current_page || 1;
                        
                        if (totalPages > 1) {
                            console.log(`üìÑ Wykryto ${totalPages} stron - pobieram wszystkie...`);
                            document.getElementById('info').textContent = `Pobieranie ${smData.pagination.total} mecz√≥w z ${totalPages} stron...`;
                            
                            // Pobierz pozosta≈Çe strony (max 5 stron = ~200 mecz√≥w)
                            for (let page = 2; page <= Math.min(totalPages, 5); page++) {
                                const pageUrl = `${PROXY}https://api.sportmonks.com/v3/football/fixtures/date/${dateStr}?api_token=${SPORTMONKS_KEY}&include=league&page=${page}`;
                                console.log(`üìÑ Pobieram stronƒô ${page}/${totalPages}...`);
                                const pageRes = await fetch(pageUrl);
                                const pageData = await pageRes.json();
                                if (pageData.data) {
                                    allFixtures = [...allFixtures, ...pageData.data];
                                    console.log(`   ‚úÖ +${pageData.data.length} mecz√≥w (razem: ${allFixtures.length})`);
                                }
                            }
                        }
                        
                        console.log(`‚úÖ RAZEM pobrano ${allFixtures.length} mecz√≥w`);
                        console.log('üìã Przyk≈Çadowy mecz (pierwszy):', allFixtures[0]);
                        console.log('üîë Klucze meczu:', Object.keys(allFixtures[0]));
                        
                        // Sprawd≈∫my strukturƒô pierwszego meczu
                        const firstMatch = allFixtures[0];
                        console.log('üè† Home team:', firstMatch.home_team || firstMatch.localteam || firstMatch.teams);
                        console.log('üöÄ Away team:', firstMatch.away_team || firstMatch.visitorteam || firstMatch.teams);
                        console.log('üèÜ Liga:', firstMatch.league || firstMatch.league_id);
                        
                        fixtures = allFixtures.map(fix => {
                            // Parsuj pole "name" kt√≥re ma format "Team1 vs Team2"
                            const matchName = fix.name || '';
                            const teams = matchName.split(' vs ');
                            const homeName = teams[0]?.trim() || 'Unknown';
                            const awayName = teams[1]?.trim() || 'Unknown';
                            
                            // Pobierz nazwƒô ligi z include (je≈õli jest)
                            let leagueName = 'Unknown League';
                            if (fix.league && fix.league.name) {
                                leagueName = fix.league.name;
                            } else if (fix.league_id) {
                                leagueName = `Liga ID: ${fix.league_id}`;
                            }
                            
                            return {
                                fixture: { id: fix.id },
                                teams: {
                                    home: { name: homeName },
                                    away: { name: awayName }
                                },
                                league: { name: leagueName }
                            };
                        });
                    }
                } else {
                    console.error('‚ùå Sportmonks b≈ÇƒÖd:', smRes.status, smRes.statusText);
                    console.error('üì¶ Odpowied≈∫ b≈Çƒôdu Sportmonks:', smData);
                    
                    // Sprawd≈∫ czy jest komunikat b≈Çƒôdu w odpowiedzi
                    if (smData.message) {
                        console.error('üí¨ Komunikat b≈Çƒôdu:', smData.message);
                    }
                    if (smData.errors) {
                        console.error('‚ö†Ô∏è Szczeg√≥≈Çy b≈Çƒôdu:', smData.errors);
                    }
                }
                
                if (!fixtures || fixtures.length === 0) {
                    console.error('‚ùå Brak mecz√≥w ze Sportmonks');
                    console.error('üîç Mo≈ºliwe przyczyny:');
                    console.error('   - Nieprawid≈Çowy endpoint API');
                    console.error('   - Nieprawid≈Çowy format daty:', dateStr);
                    console.error('   - Problemy z kluczem API');
                    console.error('   - Limit zapyta≈Ñ osiƒÖgniƒôty');
                    
                    document.getElementById('info').innerHTML = `
                        ‚ùå B≈ÇƒÖd Sportmonks (${smRes.status})<br>
                        Sprawd≈∫ konsolƒô (F12) aby zobaczyƒá szczeg√≥≈Çy
                    `;
                    document.getElementById('loader').style.display = 'none';
                    return;
                }
                
                console.log(`‚öΩ Znaleziono ${fixtures.length} mecz√≥w ze Sportmonks`);
                if (fixtures.length > 50) {
                    document.getElementById('api-status').innerHTML = `‚úÖ <strong>Sportmonks dzia≈Ça poprawnie</strong> (API-Football wy≈ÇƒÖczone) | Pobrano ${fixtures.length} mecz√≥w - tabela ma scrollowanie`;
                } else {
                    document.getElementById('api-status').innerHTML = '‚úÖ <strong>Sportmonks dzia≈Ça poprawnie</strong> (API-Football wy≈ÇƒÖczone do testu)';
                }
                
                // Przetw√≥rz mecze ze Sportmonks
                await processFixtures(fixtures);
                displayResults();
            } catch (e) {
                console.error('üí• B≈ÅƒÑD:', e);
                document.getElementById('info').textContent = 'B≈ÇƒÖd: ' + e.message;
            }
            document.getElementById('loader').style.display = 'none';
        }

        async function loadTodayMatches() {
            return loadMatchesForDate(0);
        }

        // Funkcja do pobierania historii mecz√≥w dru≈ºyny
        async function getTeamHistory(teamName, fixtureId) {
            try {
                console.log(`üîç Szukam historii dla: ${teamName}`);
                
                // Szukaj dru≈ºyny po nazwie
                const searchUrl = `${PROXY}https://api.sportmonks.com/v3/football/teams/search/${encodeURIComponent(teamName)}?api_token=${SPORTMONKS_KEY}`;
                console.log(`üì° URL szukania dru≈ºyny: ${searchUrl}`);
                
                const searchRes = await fetch(searchUrl);
                
                if (!searchRes.ok) {
                    console.error(`‚ùå B≈ÇƒÖd ${searchRes.status} przy szukaniu dru≈ºyny`);
                    return { error: `B≈ÇƒÖd API (${searchRes.status})` };
                }
                
                const searchData = await searchRes.json();
                
                if (!searchData.data || searchData.data.length === 0) {
                    return { error: 'Nie znaleziono dru≈ºyny' };
                }
                
                const teamId = searchData.data[0].id;
                console.log(`‚úÖ Znaleziono dru≈ºynƒô ${teamName}, ID: ${teamId}`);
                
                // Pobierz ostatnie mecze dru≈ºyny ZE STATYSTYKAMI
                // include=latest.statistics pobiera statystyki dla ka≈ºdego meczu
                const historyUrl = `${PROXY}https://api.sportmonks.com/v3/football/teams/${teamId}?api_token=${SPORTMONKS_KEY}&include=latest.statistics.type`;
                console.log(`üì° URL historii (teams/${teamId}/latest+statistics): ${historyUrl}`);
                
                const historyRes = await fetch(historyUrl);
                
                if (!historyRes.ok) {
                    console.error(`‚ùå B≈ÇƒÖd ${historyRes.status} przy pobieraniu historii`);
                    return { error: `B≈ÇƒÖd API historii (${historyRes.status})` };
                }
                
                const historyData = await historyRes.json();
                console.log(`üì¶ Historia dla ${teamName}:`, JSON.stringify(historyData).substring(0, 500));
                console.log(`üì¶ Pe≈Çna struktura:`, historyData);
                
                // Teams endpoint zwraca: data.latest (tablica mecz√≥w)
                const teamData = historyData.data || {};
                const fixtures = teamData.latest || [];
                
                console.log(`üìä Team data keys:`, Object.keys(teamData));
                console.log(`üìä Latest fixtures:`, fixtures.length);
                
                if (!Array.isArray(fixtures) || fixtures.length === 0) {
                    console.warn(`‚ö†Ô∏è Brak mecz√≥w w historii dla ${teamName}`);
                    console.log(`‚ö†Ô∏è Fixtures type:`, typeof fixtures, fixtures);
                    return { error: 'Brak historii mecz√≥w' };
                }
                
                console.log(`üìä Znaleziono ${fixtures.length} ostatnich mecz√≥w`);
                
                // Filtruj tylko zako≈Ñczone mecze (state_id: 5 = finished, 6/7 = finished with penalties/extra time)
                const finishedFixtures = fixtures.filter(f => f.state_id === 5 || f.state_id === 6 || f.state_id === 7);
                console.log(`‚úÖ Zako≈Ñczonych mecz√≥w: ${finishedFixtures.length}`);
                
                // WyciƒÖgnij statystyki ro≈ºnych z ostatnich 5 ZAKO≈ÉCZONYCH mecz√≥w
                const matches = finishedFixtures.slice(0, 5).map((match, index) => {
                    console.log(`\nüìã Mecz ${index + 1}: ${match.name}`);
                    console.log(`   ID: ${match.id}, Data: ${match.starting_at}`);
                    console.log(`   üÜî Szukam ro≈ºnych dla team_id: ${teamId}`);
                    
                    const stats = match.statistics || [];
                    console.log(`   üìä Statystyk: ${stats.length}`);
                    
                    if (stats.length > 0) {
                        // Poka≈º pierwsze 3 statystyki jako przyk≈Çad
                        console.log(`   üîç Przyk≈Çadowe statystyki:`, stats.slice(0, 3));
                        
                        // Poka≈º wszystkie type_id i nazwy Z participant_id
                        const types = stats.map(s => ({
                            type_id: s.type_id,
                            participant_id: s.participant_id,
                            type_name: s.type?.name || 'N/A',
                            data: s.data
                        }));
                        console.log(`   üè∑Ô∏è Wszystkie typy:`, types);
                    }
                    
                    // Szukaj ro≈ºnych DLA TEJ DRU≈ªYNY (sprawd≈∫ participant_id!)
                    // type_id: 34 = Corners w Sportmonks v3
                    const corners = stats.find(s => 
                        (s.type_id === 12 || s.type_id === 34 || s.type_id === 70 || 
                         s.type?.name?.toLowerCase().includes('corner') ||
                         s.type?.name?.toLowerCase().includes('ro≈ºn')) &&
                        s.participant_id === teamId  // ‚Üê KLUCZOWE: tylko statystyki tej dru≈ºyny!
                    );
                    
                    if (corners) {
                        console.log(`   ‚úÖ Znaleziono ro≈ºne:`, corners);
                    } else {
                        console.warn(`   ‚ö†Ô∏è NIE znaleziono statystyk ro≈ºnych!`);
                    }
                    
                    return {
                        opponent: match.name,
                        date: match.starting_at,
                        corners: corners?.data?.value || '?'
                    };
                });
                
                const avgCorners = matches
                    .filter(m => m.corners !== '?')
                    .reduce((sum, m) => sum + parseInt(m.corners), 0) / matches.length;
                
                return { teamId, matches, avgCorners: avgCorners.toFixed(1) };
            } catch (e) {
                console.error('B≈ÇƒÖd pobierania historii:', e);
                return { error: e.message };
            }
        }

        // Funkcja do pokazywania/ukrywania szczeg√≥≈Ç√≥w (MUSI BYƒÜ W WINDOW)
        window.toggleDetails = function(matchId) {
            console.log('üîç toggleDetails wywo≈Çane dla:', matchId, 'typ:', typeof matchId);
            console.log('üì¶ Dostƒôpne predictions:', predictions.length);
            
            // Konwertuj matchId na number (z HTML przychodzi jako string!)
            const numericId = parseInt(matchId);
            console.log('üî¢ Konwersja ID:', matchId, '‚Üí', numericId);
            
            const detailsRow = document.getElementById(`details-${matchId}`);
            if (detailsRow) {
                console.log('üóëÔ∏è Zamykam szczeg√≥≈Çy');
                detailsRow.remove();
                return;
            }
            
            // Pobierz dane meczu (por√≥wnuj number z number!)
            const match = predictions.find(p => p.id === numericId);
            if (!match) {
                console.error('‚ùå Nie znaleziono meczu o ID:', matchId);
                console.log('üìã Dostƒôpne ID:', predictions.map(p => p.id));
                return;
            }
            console.log('‚úÖ Znaleziono mecz:', match);
            
            // Dodaj wiersz ze szczeg√≥≈Çami
            const mainRow = document.querySelector(`#s-${matchId}`).closest('tr');
            const newRow = mainRow.insertAdjacentElement('afterend', document.createElement('tr'));
            newRow.id = `details-${matchId}`;
            newRow.className = 'details-row';
            newRow.innerHTML = `<td colspan="6" class="details-content">
                ‚è≥ ≈Åadowanie historii mecz√≥w...
            </td>`;
            
            // Pobierz historiƒô obu dru≈ºyn
            const homeTeam = match.homeTeam;
            const awayTeam = match.awayTeam;
            
            Promise.all([
                getTeamHistory(homeTeam, matchId),
                getTeamHistory(awayTeam, matchId)
            ]).then(([homeHistory, awayHistory]) => {
                let html = '<div style="text-align: left;">';
                
                // Historia dru≈ºyny gospodarzy
                html += `<div class="team-stats">
                    <strong>üè† ${homeTeam}</strong><br>
                    ≈örednia ro≈ºnych (ostatnie 5): <strong>${homeHistory.avgCorners || '?'}</strong><br>
                    <small style="color:#888;">`;
                if (homeHistory.matches) {
                    homeHistory.matches.forEach(m => {
                        html += `${m.opponent}: ${m.corners} ro≈ºnych<br>`;
                    });
                } else {
                    html += homeHistory.error || 'Brak danych';
                }
                html += `</small></div>`;
                
                // Historia dru≈ºyny go≈õci
                html += `<div class="team-stats">
                    <strong>üöÄ ${awayTeam}</strong><br>
                    ≈örednia ro≈ºnych (ostatnie 5): <strong>${awayHistory.avgCorners || '?'}</strong><br>
                    <small style="color:#888;">`;
                if (awayHistory.matches) {
                    awayHistory.matches.forEach(m => {
                        html += `${m.opponent}: ${m.corners} ro≈ºnych<br>`;
                    });
                } else {
                    html += awayHistory.error || 'Brak danych';
                }
                html += `</small></div>`;
                
                // FOOTYSTATS - TYMCZASOWO WY≈ÅƒÑCZONE
                html += `<br><div class="team-stats" style="background: #3a1a1a; border: 2px solid #f44;">
                    <strong>‚ö†Ô∏è FootyStats API - Tymczasowo niedostƒôpne</strong><br>`;
                html += `<small style="color:#faa;">Endpoint /team-matches zwraca 404, proxy blokuje (403).<br>`;
                html += `Pracujƒô nad rozwiƒÖzaniem - na razie u≈ºywam Sportmonks.</small>`;
                html += `</div>`;
                
                html += `<br><small style="color:#aaa;">üí° Historia ro≈ºnych + statystyki Sportmonks = solidne dane</small>`;
                html += '</div>';
                
                newRow.querySelector('.details-content').innerHTML = html;
            });
        };

        async function checkAvailableLeagues() {
            document.getElementById('loader').style.display = 'inline-block';
            document.getElementById('info').textContent = 'üîç Sprawdzam dostƒôpne ligi w Sportmonks...';
            
            try {
                // Pobierz listƒô lig dostƒôpnych w subskrypcji (z krajem)
                const url = `${PROXY}https://api.sportmonks.com/v3/football/leagues?api_token=${SPORTMONKS_KEY}&include=country`;
                console.log('üì° Sprawdzam dostƒôpne ligi:', url);
                
                const res = await fetch(url);
                const data = await res.json();
                
                console.log('üì¶ Odpowied≈∫ o ligach:', data);
                
                if (data.data && data.data.length > 0) {
                    console.log(`‚úÖ Znaleziono ${data.data.length} lig w Twoim planie`);
                    
                    // NIE FILTRUJEMY - pokazujemy WSZYSTKIE ligi z planu
                    const allLeagues = data.data;
                    
                    // Wy≈õwietl ligi w tabeli
                    const table = document.getElementById('predictions');
                    table.style.display = 'table';
                    
                    let html = `<tr>
                        <th>ID</th>
                        <th>Nazwa Ligi</th>
                        <th>Kraj</th>
                        <th>Typ</th>
                    </tr>`;
                    
                    // Sortuj po kraju, potem po nazwie
                    const sortedLeagues = allLeagues.sort((a, b) => {
                        const countryA = a.country?.name || 'ZZZ';
                        const countryB = b.country?.name || 'ZZZ';
                        if (countryA !== countryB) return countryA.localeCompare(countryB);
                        return (a.name || '').localeCompare(b.name || '');
                    });
                    
                    sortedLeagues.forEach(league => {
                        html += `<tr>
                            <td>${league.id}</td>
                            <td><strong>${league.name}</strong></td>
                            <td>${league.country?.name || '-'}</td>
                            <td>${league.type || '-'}</td>
                        </tr>`;
                    });
                    
                    table.innerHTML = html;
                    
                    // Sprawd≈∫ czy sƒÖ wa≈ºne ligi
                    const hasPoland = allLeagues.some(l => l.name?.includes('Ekstraklasa'));
                    const hasFACup = allLeagues.some(l => l.name?.includes('FA Cup'));
                    const hasCarabao = allLeagues.some(l => l.name?.includes('Carabao'));
                    
                    document.getElementById('info').innerHTML = `
                        ‚úÖ Znaleziono <strong>${data.data.length} lig</strong> w Twoim planie Sportmonks<br>
                        <small style="color:#aaa;">
                            ${hasPoland ? '‚úÖ Ekstraklasa' : '‚ùå Brak Ekstraklasy'} | 
                            ${hasFACup ? '‚úÖ FA Cup' : '‚ùå Brak FA Cup'} | 
                            ${hasCarabao ? '‚úÖ Carabao Cup' : '‚ùå Brak Carabao Cup'}
                        </small>
                    `;
                    
                    // Wy≈õwietl szczeg√≥≈Çy w konsoli
                    console.log('üìã WSZYSTKIE DOSTƒòPNE LIGI:');
                    data.data.forEach((league, index) => {
                        console.log(`${index + 1}. [${league.id}] ${league.name} (${league.country?.name || 'N/A'}) - ${league.is_active ? 'Aktywna' : 'Nieaktywna'}`);
                    });
                    
                    // Poka≈º info o subskrypcji
                    console.log('üìä PE≈ÅNA ODPOWIED≈π (subscription, pagination, rate_limit):', {
                        subscription: data.subscription,
                        pagination: data.pagination,
                        rate_limit: data.rate_limit
                    });
                    
                    if (data.subscription) {
                        const sub = Array.isArray(data.subscription) ? data.subscription[0] : data.subscription;
                        console.log('üìä INFORMACJE O SUBSKRYPCJI:', sub);
                        
                        let subInfo = '';
                        if (sub.plan) subInfo += `Plan: <strong>${sub.plan}</strong> | `;
                        if (sub.sport) subInfo += `Sport: ${sub.sport} | `;
                        if (sub.category) subInfo += `Kategoria: ${sub.category}`;
                        
                        document.getElementById('api-status').innerHTML = `
                            ‚ÑπÔ∏è ${subInfo || 'Brak szczeg√≥≈Ç√≥w subskrypcji'}
                        `;
                    } else {
                        document.getElementById('api-status').innerHTML = `
                            ‚ö†Ô∏è Brak informacji o subskrypcji w odpowiedzi API
                        `;
                    }
                    
                } else {
                    document.getElementById('info').textContent = '‚ùå Brak dostƒôpnych lig lub problem z API';
                    console.error('Brak lig w odpowiedzi:', data);
                }
                
            } catch (e) {
                console.error('üí• B≈ÅƒÑD podczas sprawdzania lig:', e);
                document.getElementById('info').textContent = 'B≈ÇƒÖd: ' + e.message;
            }
            
            document.getElementById('loader').style.display = 'none';
        }


        async function getAllProbabilities(home, away, id, league) {
            try {
                console.log('  üì° Pobieranie prawdopodobie≈Ñstw z API...');
                
                // ‚úÖ W≈ÅƒÑCZONE: FootyStats (prawdziwe dane!)
                const p2 = await getFootyStatsProb(home, away);
                
                // ‚ö†Ô∏è WY≈ÅƒÑCZONE: Pozosta≈Çe API (na razie)
                const p1 = 65; // Sportmonks - warto≈õƒá domy≈õlna
                const p3 = null; // API-Football - wy≈ÇƒÖczone (limit)
                const p4 = null; // TotalCorner - wy≈ÇƒÖczone
                const p5 = null; // BetOnCorners - wy≈ÇƒÖczone
                const p6 = null; // CornerStat - wy≈ÇƒÖczone
                
                console.log(`  1Ô∏è‚É£ Sportmonks: ${p1}% (DOMY≈öLNA)`);
                console.log(`  2Ô∏è‚É£ FootyStats: ${p2 ? p2 + '%' : 'BRAK DANYCH'}`);
                console.log(`  3Ô∏è‚É£ API-Football: WY≈ÅƒÑCZONE (limit)`);
                console.log(`  4Ô∏è‚É£ TotalCorner: WY≈ÅƒÑCZONE`);
                console.log(`  5Ô∏è‚É£ BetOnCorners: WY≈ÅƒÑCZONE`);
                console.log(`  6Ô∏è‚É£ CornerStat: WY≈ÅƒÑCZONE`);
                
                // Zwr√≥ƒá tylko te kt√≥re majƒÖ warto≈õƒá
                const probs = [p1, p2, p3, p4, p5, p6].filter(p => p !== null);
                return probs.length > 0 ? probs : [65]; // fallback je≈õli wszystko null
            } catch (e) {
                console.error('  ‚ùå B≈ÇƒÖd w getAllProbabilities:', e);
                return [65]; // fallback
            }
        }

        // === 1. SPORTMONKS ===
        async function getSportmonksProb(id) {
            if (!SPORTMONKS_KEY || SPORTMONKS_KEY.includes('TU_WKLEJ')) return 65;
            try {
                const url = `${PROXY}https://api.sportmonks.com/v3/football/fixtures/${id}?include=statistics&api_token=${SPORTMONKS_KEY}`;
                const res = await fetch(url);
                if (!res.ok) return 60;
                const data = await res.json();
                const stats = data.data?.[0]?.statistics;
                const avg = stats ? ((stats.home?.corners || 0) + (stats.away?.corners || 0)) / 2 : 9;
                return Math.min(95, 50 + (avg - 9) * 10);
            } catch { return 60; }
        }

        // === 2. FOOTYSTATS - TYMCZASOWO WY≈ÅƒÑCZONE (404/403 b≈Çƒôdy) ===
        async function getFootyStatsProb(home, away) {
            // ‚ö†Ô∏è WY≈ÅƒÑCZONE: endpoint /team-matches zwraca 404, a corsproxy.io blokuje (403)
            console.log(`  üìä FootyStats: WY≈ÅƒÑCZONE (b≈ÇƒÖd API)`);
            return null;
            
            /* ORYGINALNY KOD (do naprawy p√≥≈∫niej):
            try {
                console.log(`  üìä FootyStats: ${home} vs ${away}`);
                
                // FootyStats wymaga team_id, wiƒôc u≈ºywamy wyszukiwania
                const searchHome = home.toLowerCase().replace(/\s+/g, '-');
                const searchAway = away.toLowerCase().replace(/\s+/g, '-');
                
                // Szukamy meczu w FootyStats
                const url = `${PROXY}https://api.footystats.org/team-matches?key=${FOOTYSTATS_KEY}&team_name=${encodeURIComponent(home)}`;
                const res = await fetch(url);
                
                if (!res.ok) {
                    console.warn(`  ‚ö†Ô∏è FootyStats: b≈ÇƒÖd ${res.status}`);
                    return null;
                }
                
                const data = await res.json();
                console.log(`  üì¶ FootyStats odpowied≈∫:`, data);
                
                // Szukamy prawdopodobie≈Ñstwa over 9.5 corners
                if (data.data && data.data.length > 0) {
                    // Szukamy meczu home vs away
                    const match = data.data.find(m => 
                        (m.homeTeam?.name === home && m.awayTeam?.name === away) ||
                        (m.home_name === home && m.away_name === away)
                    );
                    
                    if (match) {
                        const cornersProb = match.over_9_5_corners_probability || 
                                          match.corners_prediction?.over_9_5 ||
                                          null;
                        
                        if (cornersProb) {
                            console.log(`  ‚úÖ FootyStats: ${cornersProb}%`);
                            return Math.round(cornersProb);
                        }
                    }
                    
                    // Je≈õli nie ma konkretnego meczu, u≈ºyj ≈õredniej dru≈ºyny
                    const avgCorners = data.team_stats?.avg_corners_total || 9.5;
                    const prob = avgCorners > 10 ? 70 : 55;
                    console.log(`  ‚ÑπÔ∏è FootyStats (avg): ${prob}% (≈õr. ro≈ºnych: ${avgCorners})`);
                    return prob;
                }
                
                console.warn(`  ‚ö†Ô∏è FootyStats: brak danych`);
                return null;
            } catch (e) {
                console.error('  ‚ùå FootyStats error:', e);
                return null;
            }
            */
        }

        // === 3. API-FOOTBALL ===
        async function getApiFootballProb(id) {
            try {
                const url = `${PROXY}https://v3.football.api-sports.io/fixtures/statistics?fixture=${id}`;
                const res = await fetch(url, { headers: { 'x-apisports-key': API_FOOTBALL_KEYS[currentKeyIndex] } });
                if (!res.ok) return 58;
                const data = await res.json();
                if (!data.response.length) return 58;
                const hc = data.response[0].statistics.find(s => s.type === 'Corner Kicks')?.value || 0;
                const ac = data.response[1].statistics.find(s => s.type === 'Corner Kicks')?.value || 0;
                const avg = (hc + ac) * 2.2;
                return Math.min(95, 45 + (avg - 8) * 12);
            } catch { return 58; }
        }

        // === 4. TOTALCORNER.COM (scrap) ===
        async function getTotalCornerProb(home, away) {
            try {
                const url = `${PROXY}https://www.totalcorner.com/match/corner-stats/${home.replace(/ /g,'-')}-vs-${away.replace(/ /g,'-')}`;
                const html = await fetch(url).then(r => r.text());
                const match = html.match(/Average Corners per Match.*?(\d+\.\d+)/s);
                const avg = match ? parseFloat(match[1]) : 9.5;
                return Math.min(95, 50 + (avg - 9) * 12);
            } catch { return 70; }
        }

        // === 5. BETONCORNERS.COM (scrap) ===
        async function getBetOnCornersProb(home) {
            try {
                const url = `${PROXY}https://www.betoncorners.com/statistics/${home.toLowerCase().replace(/ /g,'-')}`;
                const html = await fetch(url).then(r => r.text());
                const match = html.match(/Average Corners per Game.*?(\d+\.\d+)/s);
                const avg = match ? parseFloat(match[1]) : 9;
                return Math.min(95, 55 + (avg - 9) * 15);
            } catch { return 68; }
        }

        // === 6. CORNER-STAT.COM (scrap) ===
        async function getCornerStatProb(home, away) {
            try {
                const url = `${PROXY}https://corner-stat.com/match/${home.toLowerCase().replace(/ /g,'-')}-vs-${away.toLowerCase().replace(/ /g,'-')}`;
                const html = await fetch(url).then(r => r.text());
                const match = html.match(/Corners per match.*?(\d+\.\d+)/s);
                const avg = match ? parseFloat(match[1]) : 9.2;
                return Math.min(95, 48 + (avg - 9) * 14);
            } catch { return 66; }
        }

        function displayResults() {
            const table = document.getElementById('predictions');
            table.style.display = 'table';
            let html = `<tr><th>Mecz</th><th>Liga</th><th>≈örednia %</th><th>ZGODNO≈öƒÜ</th><th>Link</th><th>Status</th></tr>`;

            if (predictions.length === 0) {
                html += `<tr><td colspan="6">Brak mecz√≥w spe≈ÇniajƒÖcych kryteria (zgdn.‚â•30%, ≈õr.‚â•55%).</td></tr>`;
            } else {
                predictions.forEach(p => {
                    const cls = p.agree >= 80 ? 'high' : p.agree >= 70 ? 'medium' : '';
                    html += `<tr>
                        <td><strong>${p.match}</strong><br>
                            <span class="expand-btn" onclick="toggleDetails('${p.id}')">üìä Poka≈º historiƒô ro≈ºnych</span>
                        </td>
                        <td>${p.league}</td>
                        <td>${p.avgProb}%</td>
                        <td class="${cls}">${p.agree}%</td>
                        <td><a href="${p.flashscore}" target="_blank" class="link">Flashscore</a></td>
                        <td class="pending" id="s-${p.id}">${p.status}</td>
                    </tr>`;
                });
            }
            table.innerHTML = html;
            document.getElementById('info').innerHTML = `Znaleziono <strong>${predictions.length}</strong> typ√≥w!<br><small style="color:#ffa;">‚ö†Ô∏è FootyStats wy≈ÇƒÖczony (404/403) - u≈ºywam tylko Sportmonks</small>`;
            updateStats();
        }

        async function verifyAll() {
            hits = 0; total = 0;
            for (let p of predictions) {
                const el = document.getElementById(`s-${p.id}`);
                if (!el) continue;
                try {
                    const res = await fetch(`${PROXY}https://v3.football.api-sports.io/fixtures?id=${p.id}`, {
                        headers: { 'x-apisports-key': API_FOOTBALL_KEYS[currentKeyIndex] }
                    });
                    const data = await res.json();
                    const fix = data.response[0];
                    if (fix.fixture.status.short === 'FT') {
                        const statsRes = await fetch(`${PROXY}https://v3.football.api-sports.io/fixtures/statistics?fixture=${p.id}`, {
                            headers: { 'x-apisports-key': API_FOOTBALL_KEYS[currentKeyIndex] }
                        });
                        const stats = await statsRes.json();
                        const hc = stats.response[0].statistics.find(s => s.type === 'Corner Kicks')?.value || 0;
                        const ac = stats.response[1].statistics.find(s => s.type === 'Corner Kicks')?.value || 0;
                        const totalC = hc + ac;
                        const isOver = totalC > 9.5;
                        el.textContent = isOver ? `OVER (${totalC})` : `UNDER (${totalC})`;
                        el.parentElement.className = isOver ? 'hit' : 'miss';
                        if (isOver) hits++;
                        total++;
                    } else {
                        el.textContent = 'W trakcie';
                    }
                } catch { }
            }
            updateStats();
        }

        function updateStats() {
            const hitRate = total > 0 ? Math.round((hits / total) * 100) : 0;
            const roi = total > 0 ? ((hits * 1.85) - (total - hits)).toFixed(2) : 0;
            document.getElementById('stats').innerHTML = `
                <strong>Hit Rate: ${hitRate}%</strong> | 
                <strong>ROI: ${roi > 0 ? '+' : ''}${roi} z≈Ç</strong> (kurs 1.85)
            `;
            updateChart();
        }

        function updateChart() {
            const ctx = document.getElementById('chart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Trafienia', 'Pud≈Ça'],
                    datasets: [{
                        data: [hits, total - hits],
                        backgroundColor: ['#4CAF50', '#f44336'],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } } }
            });
        }

        // Auto co 30 min
        setInterval(verifyAll, 1800000);
    </script>
</body>
</html>